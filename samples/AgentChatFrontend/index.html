<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SignalR Chat Test</title>
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e40af;
      --background-color: #f8fafc;
      --text-color: #1e293b;
      --border-color: #e2e8f0;
      --success-color: #22c55e;
      --error-color: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.5;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    h2 {
      color: var(--primary-color);
      margin-bottom: 1.5rem;
      font-size: 1.875rem;
      font-weight: 600;
    }

    .container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-color);
    }

    input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
    }

    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    #connectBtn {
      background-color: var(--primary-color);
      color: white;
    }

    #connectBtn:hover {
      background-color: var(--secondary-color);
    }

    #disconnectBtn {
      background-color: #f1f5f9;
      color: var(--text-color);
    }

    #disconnectBtn:hover {
      background-color: #e2e8f0;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #chat {
      height: 400px;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 1rem;
      margin: 1rem 0;
      overflow-y: auto;
      background: white;
    }

    .message {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      max-width: 80%;
    }

    .sent {
      background-color: var(--primary-color);
      color: white;
      margin-left: auto;
    }

    .received {
      background-color: #f1f5f9;
      color: var(--text-color);
    }

    .message-input-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    #messageInput {
      flex: 1;
    }

    #sendBtn {
      background-color: var(--primary-color);
      color: white;
      min-width: 100px;
    }

    #sendBtn:hover {
      background-color: var(--secondary-color);
    }

    .status-message {
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      background-color: #f1f5f9;
      color: var(--text-color);
      text-align: center;
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .container {
        padding: 1rem;
      }

      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Xians AI Chat</h2>
    
    <div class="form-group">
      <label>Websocket URL:</label>
      <input type="text" id="url" placeholder="Paste your Websocket URL" />
    </div>

    <div class="form-group">
      <label>Secret Key</label>
      <input type="text" id="secret" placeholder="Paste your Secret Key here" />
    </div>

    <div class="form-group">
      <label>Tenant ID:</label>
      <input type="text" id="tenantId" placeholder="Enter tenant ID" />
    </div>

    <div class="form-group">
      <label>Thread ID:</label>
      <input type="text" id="threadId" placeholder="Enter thread ID" />
    </div>

    <div class="form-group">
      <label>Agent:</label>
      <input type="text" id="agent" placeholder="Enter agent ID" />
    </div>

    <div class="form-group">
      <label>Workflow Type:</label>
      <input type="text" id="workflowType" placeholder="Enter workflow type" />
    </div>

    <div class="form-group">
      <label>Workflow ID:</label>
      <input type="text" id="workflowId" placeholder="Enter workflow ID" />
    </div>

    <div class="form-group">
      <label>Participant ID:</label>
      <input type="text" id="participantId" placeholder="Enter participant ID" />
    </div>

    <div class="button-group">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>

  <div class="container">
    <div id="chat"></div>
    <div class="message-input-container">
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
  <script>
    let connection = null;

    const secretInput = document.getElementById("secret");
    const threadInput = document.getElementById("threadId");
    const tenantInput = document.getElementById("tenantId");
    const chatBox = document.getElementById("chat");
    const messageInput = document.getElementById("messageInput");
    const connectBtn = document.getElementById("connectBtn");
    const sendBtn = document.getElementById("sendBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");
    const url = document.getElementById("url");
    let currentThreadId = null; // Initialize as null

    connectBtn.onclick = async () => {
      const token = secretInput.value.trim();
      const initialThreadId = threadInput.value.trim();
      const tenantId = tenantInput.value.trim();

      if (!token || !tenantId) {
        alert("Please enter both Secret Key and Tenant ID");
        return;
      }

      currentThreadId = initialThreadId || null; // Assign null if initialThreadId is empty

      connection = new signalR.HubConnectionBuilder()
        .withUrl(`http://localhost:5000/ws/chat?tenantId=${encodeURIComponent(tenantInput.value.trim())}`, {
          Headers: "",  
          accessTokenFactory: () => token
        })
        .configureLogging(signalR.LogLevel.Information)
        .build();

      connection.on("ReceiveMessage", (message) => {
        const div = document.createElement("div");
        div.classList.add("message", "received");
        div.textContent = "Agent: " + message;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      connection.on("InboundProcessed", (message) => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.textContent = "Inbound acknowledged";
        chatBox.appendChild(div);
        console.log('ThreadId:', message);
        currentThreadId = message || null; // Assign null if message is empty
        threadInput.value = message || ''; // Update the UI with empty string if null
      });

      try {
        await connection.start();
        // await connection.invoke("RegisterThread", currentThreadId);
        alert("Connected!");
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
      } catch (err) {
        console.error(err);
        alert("Failed to connect.");
      }
    };

    disconnectBtn.onclick = async () => {
      if (!connection || connection.state !== "Connected") {
        alert("Not connected.");
        return;
      }

      try {
        await connection.stop();
        connection = null;
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        alert("Disconnected!");
      } catch (err) {
        console.error("Failed to disconnect:", err);
        alert("Failed to disconnect.");
      }
    };

    sendBtn.onclick = async () => {
      const text = messageInput.value.trim();
      if (!text || !connection || connection.state !== "Connected") {
        alert("You must connect and enter a message.");
        return;
      }

      const message = {
        threadId: currentThreadId,
        text
      };

      const div = document.createElement("div");
      div.classList.add("message", "sent");
      div.textContent = "You: " + text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      const request = {
        threadId: currentThreadId || null,
        agent: document.getElementById("agent").value,
        workflowType: document.getElementById("workflowType").value,
        workflowId: document.getElementById("workflowId").value,
        participantId: document.getElementById("participantId").value,
        content: text,
        metadata: null
      };
      messageInput.value = "";

      try {
        await connection.invoke("SendInboundMessage", request);
      } catch (err) {
        console.error("Failed to send message:", err);
      }
    };
  </script>
</body>
</html>
