# Chat Interceptors

Chat interceptors provide a powerful mechanism to intercept and modify chat messages both before they are processed by the LLM and after the LLM generates a response. This functionality is specifically designed for **Chat message types only** and enables you to implement custom logic for message processing, filtering, transformation, or blocking.

## Overview

Chat interceptors implement the `IChatInterceptor` interface and allow you to:

- **Intercept incoming messages** before they reach the LLM for processing
- **Intercept outgoing messages** after the LLM generates a response but before sending to the user
- **Modify message content** at both incoming and outgoing stages
- **Block or filter messages** based on custom logic
- **Add additional processing** such as logging, validation, or enrichment
- **Transform message format** or content structure

## The IChatInterceptor Interface

The `IChatInterceptor` interface defines two key methods for message interception:

```csharp
public interface IChatInterceptor
{
    Task<MessageThread> InterceptIncomingMessageAsync(MessageThread messageThread);
    Task<string> InterceptOutgoingMessageAsync(MessageThread messageThread, string? response);
}
```

### InterceptIncomingMessageAsync

This method is called **before** the message thread is processed by the LLM.

**Parameters:**

- `messageThread`: The incoming message thread containing the user's message and conversation history

**Returns:**

- `MessageThread`: The (potentially modified) message thread to be processed by the LLM

**Use Cases:**

- Validate or sanitize incoming messages
- Add context or metadata to messages
- Filter out inappropriate content
- Transform message format
- Block messages by returning an empty or modified thread

### InterceptOutgoingMessageAsync

This method is called **after** the LLM generates a response but **before** it's sent to the user.

**Parameters:**

- `messageThread`: The complete message thread including the conversation history
- `response`: The LLM-generated response (can be null)

**Returns:**

- `string`: The (potentially modified) response to be sent to the user

**Use Cases:**

- Post-process LLM responses
- Add formatting or additional information
- Filter or censor response content
- Log interactions
- Transform response format
- Block responses by returning empty string

## Implementation Example

Here's a basic implementation of a chat interceptor:

```csharp
using XiansAi.Flow;
using XiansAi.Messaging;

namespace Agents.LegalContract;

public class ChatInterceptor : IChatInterceptor
{
    public Task<MessageThread> InterceptIncomingMessageAsync(MessageThread messageThread)
    {
        // Example: Log incoming messages
        Console.WriteLine($"Incoming message: {messageThread.LastMessage?.Content}");
        
        // Example: Add timestamp to message
        if (messageThread.LastMessage != null)
        {
            messageThread.LastMessage.Content = $"[{DateTime.Now:HH:mm:ss}] {messageThread.LastMessage.Content}";
        }
        
        return Task.FromResult(messageThread);
    }

    public Task<string> InterceptOutgoingMessageAsync(MessageThread messageThread, string? response)
    {
        response = response ?? string.Empty;
        
        // Example: Add signature to responses
        if (!string.IsNullOrEmpty(response))
        {
            response += "\n\n---\n*Response generated by Legal Contract Agent*";
        }
        
        // Example: Log outgoing responses
        Console.WriteLine($"Outgoing response: {response}");
        
        return Task.FromResult(response);
    }
}
```

## Setting Up Chat Interceptors

To register a chat interceptor with your bot, use the `SetChatInterceptor` method during bot configuration:

```csharp
using DotNetEnv;
using XiansAi.Flow;
using Agents.LegalContract;

// Load environment variables
Env.Load();
Console.WriteLine("Starting Legal Contract Agent...\n");

var agent = new Agent("Legal Contract Agent");

var bot = agent.AddBot<LegalContractBot>();
bot.AddCapabilities(typeof(GeneralCapabilities));

// Set the chat interceptor
bot.SetChatInterceptor(new ChatInterceptor());

await agent.RunAsync();
```

## Important Notes

- **Chat Message Type Only**: Chat interceptors only work with Chat message types and will not be triggered for other message types
- **Order of Execution**: Incoming interceptor runs before LLM processing, outgoing interceptor runs after LLM processing
- **Thread Safety**: Ensure your interceptor implementation is thread-safe if handling concurrent requests
- **Error Handling**: Implement proper error handling to prevent interceptor failures from breaking the chat flow
- **Performance**: Keep interceptor logic lightweight to avoid introducing latency in message processing

Chat interceptors provide a flexible way to customize your bot's message handling behavior while maintaining clean separation of concerns in your agent architecture.
